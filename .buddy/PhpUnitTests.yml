- pipeline: "php-unit-tests"
  events:
      - type: "PUSH"
        refs:
            - "refs/heads/main"
  fail_on_prepare_env_warning: true
  actions:
      - action: "run unit tests"
        type: "BUILD"
        docker_image_name: "library/php"
        docker_image_tag: "8.3"
        execute_commands:
            - "cd baserepo"
            - "composer install --prefer-dist --no-interaction --no-progress"
            - "cp .env.example .env"
            - "php artisan key:generate"
            - "vendor/bin/phpunit"

        setup_commands:
            - 'echo "date.timezone=UTC\nmemory_limit=-1\ndefault_socket_timeout=10\nsession.gc_probability=0\napc.enable_cli=1\nzend.assertions=1" >> /usr/local/etc/php/conf.d/buddy.ini'
            - "apt-get update && apt-get install -y git zip parallel"
            - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
            - ""
            - "# php ext gd"
            - "apt-get install -y libfreetype6-dev"
            - "apt-get install -y libjpeg62-turbo-dev"
            - "apt-get install -y libpng-dev"
            - "docker-php-ext-configure gd --with-freetype --with-jpeg"
            - "docker-php-ext-install gd"
            - ""
            - "# php ext pdo_mysql"
            - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
            - "docker-php-ext-install pdo_mysql"
            - ""
            - "# php ext zip"
            - "apt-get install -y zip"
            - "apt-get install -y unzip"
            - "apt-get install -y zlib1g-dev"
            - "apt-get install -y libzip-dev"
            - "docker-php-ext-install zip"
            - ""
            - "# php ext mbstring"
            - "apt-get install -y libonig-dev"
            - "docker-php-ext-install mbstring"
        shell: "BASH"
